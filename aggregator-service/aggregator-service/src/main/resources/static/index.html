<!doctype html>
<html lang="en" data-bs-theme="dark"> <!-- Added data-bs-theme="dark" -->
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <!-- Optional: Add a link to a custom CSS file if you want more specific styling -->
    <!-- <link rel="stylesheet" href="custom.css"> -->
    <style>
        body {
            /* Bootstrap's dark theme will handle body background, 
               but you can override if needed e.g., background-color: #121212; */
        }
        .platform-header {
            background-color: #0d6efd; /* Bootstrap primary blue, can be adjusted */
            color: white;
            padding: 2rem 1rem;
            margin-bottom: 2rem;
            border-radius: 0.3rem;
        }

        /* Adjust card styles for dark theme if Bootstrap defaults aren't enough */
        .card-stock {
            /* background-color: #212529; /* Example: A slightly lighter dark for cards */
            /* border: 1px solid #495057; */
        }
        .card-stock .card-header {
            font-weight: bold;
            /* background-color: #343a40; /* Darker header for cards */
            /* color: #f8f9fa; */
        }
        .stock-price {
            font-size: 1.75rem;
            font-weight: 500;
            color: #198754; /* Bootstrap success color, generally visible on dark */
        }
        .profile-card-img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 1rem auto;
            display: block;
            background-color: #495057; /* Darker placeholder background */
            border: 2px solid #6c757d; /* Optional border for placeholder */
        }

        /* Portfolio value colors might need adjustment if default success/danger are not contrasting enough */
        .portfolio-value.text-success {
            font-weight: bold;
            color: #198754 !important; /* Ensure Bootstrap success color is used */
        }
        .portfolio-value.text-danger {
            font-weight: bold;
            color: #dc3545 !important; /* Ensure Bootstrap danger color is used */
        }

        /* Ensure table text is readable */
        .table {
            /* color: #dee2e6; */ /* Light grey text for table content if needed */
        }
        .table-light th { /* Portfolio table header */
            /* background-color: #343a40; */
            /* color: #f8f9fa; */
        }

        /* Footer text color */
        .text-muted {
            /* color: #adb5bd !important; /* Lighter muted color for dark theme */
        }

    </style>

    <title>Trading Platform</title>
</head>
<body>

<div class="container-fluid mt-3">

    <header class="platform-header text-center">
        <h1>Trading Platform</h1>
    </header>

    <div class="container">
        <h2 class="mb-4 text-center">Tradable Stocks</h2>
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4 mb-5">
            <!-- APPLE -->
            <div class="col">
                <div class="card h-100 shadow-sm card-stock">
                    <div class="card-header text-center">APPLE</div>
                    <div class="card-body text-center">
                        <h5 class="stock-price mb-3" id="APPLE">$100</h5>
                        <div class="d-flex justify-content-around">
                            <button type="button" class="btn btn-success btn-sm" onclick="trade('APPLE', 'BUY')">Buy</button>
                            <button type="button" class="btn btn-warning btn-sm" onclick="trade('APPLE', 'SELL')">Sell</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- AMAZON -->
            <div class="col">
                <div class="card h-100 shadow-sm card-stock">
                    <div class="card-header text-center">AMAZON</div>
                    <div class="card-body text-center">
                        <h5 class="stock-price mb-3" id="AMAZON">$100</h5>
                        <div class="d-flex justify-content-around">
                            <button type="button" class="btn btn-success btn-sm" onclick="trade('AMAZON', 'BUY')">Buy</button>
                            <button type="button" class="btn btn-warning btn-sm" onclick="trade('AMAZON', 'SELL')">Sell</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- GOOGLE -->
            <div class="col">
                <div class="card h-100 shadow-sm card-stock">
                    <div class="card-header text-center">GOOGLE</div>
                    <div class="card-body text-center">
                        <h5 class="stock-price mb-3" id="GOOGLE">$100</h5>
                        <div class="d-flex justify-content-around">
                            <button type="button" class="btn btn-success btn-sm" onclick="trade('GOOGLE', 'BUY')">Buy</button>
                            <button type="button" class="btn btn-warning btn-sm" onclick="trade('GOOGLE', 'SELL')">Sell</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- MICROSOFT -->
            <div class="col">
                <div class="card h-100 shadow-sm card-stock">
                    <div class="card-header text-center">MICROSOFT</div>
                    <div class="card-body text-center">
                        <h5 class="stock-price mb-3" id="MICROSOFT">$100</h5>
                        <div class="d-flex justify-content-around">
                            <button type="button" class="btn btn-success btn-sm" onclick="trade('MICROSOFT', 'BUY')">Buy</button>
                            <button type="button" class="btn btn-warning btn-sm" onclick="trade('MICROSOFT', 'SELL')">Sell</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <h2 class="mb-4 text-center">Customer Dashboard</h2>
        <div class="row g-4">
            <!-- Profile Section -->
            <div class="col-lg-4">
                <div class="card shadow-sm h-100"> <!-- Bootstrap dark theme will style cards -->
                    <div class="card-header">
                        <h5 class="mb-0">Profile</h5>
                    </div>
                    <div class="card-body text-center">
                        <div class="profile-card-img mb-3">
                             <!-- <img src="path/to/your/image.jpg" alt="Profile Picture" class="profile-card-img"> -->
                        </div>
                        <h4 class="card-title" id="customer-profile-name">Customer Name</h4>
                        <hr> <!-- hr will also be styled by Bootstrap dark theme -->
                        <div class="row mt-3">
                            <div class="col text-start"><strong>Available Balance:</strong></div>
                            <div class="col text-end" id="customer-available-balance">$0</div>
                        </div>
                        <div class="row mt-2">
                            <div class="col text-start"><strong>Portfolio Value:</strong></div>
                            <div class="col text-end portfolio-value" id="customer-portfolio-value">$0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Portfolio Section -->
            <div class="col-lg-8">
                <div class="card shadow-sm h-100">
                    <div class="card-header">
                        <h5 class="mb-0">Portfolio Holdings</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                             <!-- table-dark class can be added for explicit dark table styling -->
                            <table class="table table-hover" id="customer-portfolio">
                                <thead class="table-light"> <!-- This class might make header light on dark, consider removing or changing -->
                                <!-- Or use a darker variant for thead if table-light is too bright:
                                <thead class="table-dark"> 
                                or simply <thead> and let Bootstrap's data-bs-theme handle it.
                                -->
                                <thead>
                                <tr>
                                    <th scope="col">#</th>
                                    <th scope="col">Stock</th>
                                    <th scope="col">Quantity</th>
                                    <th scope="col">Current Value</th>
                                </tr>
                                </thead>
                                <tbody>
                                <!-- Portfolio rows will be inserted here by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alerts Section -->
        <div id="alerts" class="mt-4">
            <!-- Alert messages will be appended here -->
            <!-- Bootstrap dark theme will style alerts appropriately -->
        </div>
    </div>

    <footer class="text-center text-muted py-4 mt-5">
        <p>&copy; 2025 Trading Platform</p>
    </footer>

    <script>
        // get customer id
        const params = new URLSearchParams(window.location.search);
        const customerId = params.get('customer') || '1'; // Default to customer 1 if not specified
        let stockPrices = {};
        let customerPortfolioValue = {}; // This will store value per stock ticker + BALANCE
        // console.log(customerId);

        // elements
        const customerProfileNameElement = document.getElementById('customer-profile-name');
        const customerPortfolioValueElement = document.getElementById('customer-portfolio-value');
        const customerAvailableBalanceElement = document.getElementById('customer-available-balance');
        const customerPortfolioContainer = document.getElementById('customer-portfolio').querySelector('tbody');
        const alertsContainer = document.getElementById('alerts'); // Renamed for clarity

        // get price updates
        const stockPriceUpdates = () => {
            var source = new EventSource("/stock/price-stream");
            source.onmessage = (evt) => {
                try {
                    let event = JSON.parse(evt.data);
                    let stockPriceDisplayElement = document.getElementById(event.ticker);
                    if (stockPriceDisplayElement) {
                        stockPriceDisplayElement.innerText = `$${event.price}`;
                    }
                    stockPrices[event.ticker] = event.price;

                    let customerQuantityElement = document.getElementById(`customer-quantity-${event.ticker}`);
                    if (customerQuantityElement) {
                        let q = parseInt(customerQuantityElement.innerText);
                        let currentStockValue = q * event.price;
                        document.getElementById(`customer-value-${event.ticker}`).innerText = `$${currentStockValue.toFixed(2)}`;
                        customerPortfolioValue[event.ticker] = currentStockValue;
                        updateCustomerPortfolioDisplayValue();
                    }
                } catch (e) {
                    console.error("Error processing SSE message:", e, evt.data);
                }
            };
            source.onerror = (err) => {
                console.error("EventSource failed:", err);
                showAlert('Connection to price stream lost. Please refresh.', 'danger');
                source.close(); // Close the connection to prevent multiple retries by browser
            };
        };

        // get customer information & portfolio
        const fetchCustomerInformation = async () => {
            if (!customerId) {
                showAlert('Customer ID is missing in the URL.', 'danger');
                customerProfileNameElement.innerText = "Unknown Customer";
                return;
            }
            try {
                const response = await fetch(`/customers/${customerId}`);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: `Error fetching customer data: ${response.statusText}` }));
                    showAlert(errorData.detail || `Failed to load customer data. Status: ${response.status}`, 'danger');
                    return;
                }
                const customer = await response.json();
                customerProfileNameElement.innerText = customer.name;
                customerAvailableBalanceElement.innerText = `$${customer.balance.toFixed(2)}`;

                // Clear previous portfolio
                while (customerPortfolioContainer.firstChild) {
                    customerPortfolioContainer.removeChild(customerPortfolioContainer.firstChild);
                }
                
                customerPortfolioValue = {}; // Reset portfolio value calculation object
                customerPortfolioValue['BALANCE'] = customer.balance; // Add balance to portfolio calculation

                if (customer.holdings && customer.holdings.length > 0) {
                    customer.holdings.map((holding, index) => getPortfolioRow(holding, index)).forEach((rowElement) => customerPortfolioContainer.append(rowElement));
                    customer.holdings.forEach(holding => {
                        const currentPrice = getStockPriceFromCache(holding.ticker);
                        customerPortfolioValue[holding.ticker] = (holding.quantity * currentPrice);
                    });
                } else {
                     const tr = document.createElement('tr');
                     tr.innerHTML = `<td colspan="4" class="text-center">No holdings to display.</td>`;
                     customerPortfolioContainer.append(tr);
                }
                updateCustomerPortfolioDisplayValue();
            } catch (error) {
                console.error("Error fetching customer information:", error);
                showAlert('Could not fetch customer information. Please try again later.', 'danger');
            }
        }

        const updateCustomerPortfolioDisplayValue = () => {
            const sumOfStockValues = Object.entries(customerPortfolioValue)
                                      .filter(([key, _]) => key !== 'BALANCE')
                                      .reduce((acc, [_, val]) => acc + val, 0);
            
            // Total portfolio value includes stock values + available balance
            const totalValue = sumOfStockValues + (customerPortfolioValue['BALANCE'] || 0);

            customerPortfolioValueElement.innerText = `$${totalValue.toFixed(2)}`;
            // Using Bootstrap's text color utilities which should adapt with data-bs-theme
            if (totalValue >= 10000) {
                customerPortfolioValueElement.className = 'col text-end portfolio-value text-success';
            } else {
                customerPortfolioValueElement.className = 'col text-end portfolio-value text-danger';
            }
        };

        const getPortfolioRow = (holding, index) => {
            const tr = document.createElement('tr');
            const currentPrice = getStockPriceFromCache(holding.ticker);
            const value = holding.quantity * currentPrice;
            tr.innerHTML = `
                            <th scope="row">${index + 1}</th>
                            <td>${holding.ticker}</td>
                            <td id="customer-quantity-${holding.ticker}">${holding.quantity}</td>
                            <td id="customer-value-${holding.ticker}">$${value.toFixed(2)}</td>
            `;
            return tr;
        }

        const getStockPriceFromCache = (ticker) => {
            return stockPrices[ticker] ? stockPrices[ticker] : 0;
        }

        const trade = async (ticker, action) => {
            if (!customerId) {
                showAlert('Cannot trade: Customer ID is missing.', 'warning');
                return;
            }
            try {
                const response = await fetch(`/customers/${customerId}/trade`, {
                    method: "POST",
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ticker,
                        action,
                        quantity: 1 // Still fixed quantity
                    })
                });
                const data = await response.json();
                if (response.ok) {
                    showAlert(`Trade successful: ${action} ${ticker}`, 'success');
                    fetchCustomerInformation(); // Refresh customer data
                } else {
                    showAlert(data.detail || `Trade failed: ${response.statusText}`, 'danger');
                }
            } catch (error) {
                console.error("Trade error:", error);
                showAlert('An error occurred while processing the trade.', 'danger');
            }
        };

        const showAlert = (msg, level = 'info') => { // Default level to 'info'
            const div = document.createElement('div');
            // Added role="alert" for accessibility and a close button
            div.innerHTML = `
                <div class="alert alert-${level} alert-dismissible fade show" role="alert">
                    ${msg}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            alertsContainer.append(div);
            // Bootstrap's dismissible alert handles its own removal, or you can keep timeout
            setTimeout(() => {
                 // Check if the element still exists before trying to remove
                if (div.parentElement) {
                    // Gently fade out then remove
                    div.classList.remove('show');
                    setTimeout(() => div.remove(), 150); // Wait for fade out
                }
            }, 5000); // Increased timeout for better readability
        };

        // trigger these functions on page load
        document.addEventListener("DOMContentLoaded", () => {
            stockPriceUpdates();
            fetchCustomerInformation();
        });
    </script>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
</body>
</html>